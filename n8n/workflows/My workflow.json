{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "12b46a98-be58-4d13-a55f-6e6fd8962770",
                    "leftValue": "={{ $json.isValid }}",
                    "rightValue": "listar",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Caso exitoso"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c2e7a391-728f-47aa-bca5-118b480cca5a",
                    "leftValue": "={{ $json.isValid }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Caso de error"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -96,
        96
      ],
      "id": "79af0186-0b84-43ea-bd52-d70be0b9f69f",
      "name": "Check Validity"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "agendar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3b74fbf6-1892-4571-9dfe-adce270d9f8c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Crear evento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ea2484b8-31f2-4b12-b251-41a952937de8",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "modificar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Editar evento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ab3e074d-2ef5-4904-8c30-38b83bccb6e3",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "cancelar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Eliminar evento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ca3d483a-7dfd-48f5-8e82-15a855e2906e",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "checar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Consultar eventos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "03204602-fb43-4bed-94b9-ad5a1765df14",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "bienvenida",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "bienvenida"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2efdd538-2ae8-4ff6-9d83-1d51fa82cec0",
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ayuda",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ayuda"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        192,
        -16
      ],
      "id": "ae06204f-5f32-4a20-99c6-1151a304ba0f",
      "name": "Action Router"
    },
    {
      "parameters": {
        "chatId": "={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        960,
        352
      ],
      "id": "37548012-ee9c-4a1f-9cc8-c4650d79c1c4",
      "name": "Send a text message3",
      "webhookId": "e2e1c624-1311-4d2a-8f95-7f91272bbdee",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "text": "=‚úÖ Evento Modificado: {{ $json.updatedEvents[0].link }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        752,
        -48
      ],
      "id": "f41d8641-ac4e-467e-a7b5-7a6f92ca58c4",
      "name": "Send a text message5",
      "webhookId": "98536582-1105-4149-9a17-c5147f24d263",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "text": "=üóëÔ∏è Evento Eliminado: {{ $json.eventLink }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        752,
        144
      ],
      "id": "806edb9e-db67-4334-a89c-6a2ff4f7597f",
      "name": "Send a text message6",
      "webhookId": "98536582-1105-4149-9a17-c5147f24d263",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -960,
        112
      ],
      "id": "037af27c-3986-4401-91a5-77cb4af64488",
      "name": "Mensaje del usuario",
      "webhookId": "d03751f7-9d80-4ba3-8024-8fa2c725f177",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://google-auth-server-ds--telegram-bot-ac92a.us-central1.hosted.app/api/user-exists?firebaseUid={{ $json.message.chat.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -720,
        112
      ],
      "id": "2a00fe52-5fa2-4a84-801d-6f003a0e630a",
      "name": "Verificar en BD status de autenticacion",
      "credentials": {
        "httpHeaderAuth": {
          "id": "kD67zWQcLpvywNGg",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "content": "Si el usuario no esta autenticado, se debe de autenticar y la siguiente vez que mande mensaje ya estara autenticado sin la necesidad de caer en este flujo de nuevo"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -496,
        512
      ],
      "id": "96357a42-dc43-4505-b867-195355c287e5",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "url": "=https://google-auth-server-ds--telegram-bot-ac92a.us-central1.hosted.app/auth/initiate-google-calendar-auth?telegramUserId={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -512,
        336
      ],
      "id": "e89b0f72-a856-4efb-9e78-3c6a8d86edd8",
      "name": "Autenticar usuario",
      "credentials": {
        "httpHeaderAuth": {
          "id": "kD67zWQcLpvywNGg",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://google-auth-server-ds--telegram-bot-ac92a.us-central1.hosted.app/api/create-calendar-event",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        544,
        -256
      ],
      "id": "032f0323-3787-44c5-bdb4-fece9cfb99c4",
      "name": "Crear evento en calendario",
      "credentials": {
        "httpHeaderAuth": {
          "id": "kD67zWQcLpvywNGg",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ada035ac-9082-40c8-972b-24e8e0a2c6a6",
              "leftValue": "={{ $json.exists }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -512,
        112
      ],
      "id": "3f74b183-884b-46fe-8e61-7f4adb300da8",
      "name": "autenticado?"
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "https://google-auth-server-ds--telegram-bot-ac92a.us-central1.hosted.app/api/update-calendar-event",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        544,
        -48
      ],
      "id": "2b2024d5-42fe-4fa8-9a6c-31c5c8bfe55e",
      "name": "Editar evento",
      "credentials": {
        "httpHeaderAuth": {
          "id": "kD67zWQcLpvywNGg",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "https://google-auth-server-ds--telegram-bot-ac92a.us-central1.hosted.app/api/delete-calendar-event",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        544,
        144
      ],
      "id": "bc11c921-000e-4946-8132-02380ce9e311",
      "name": "Eliminar evento",
      "credentials": {
        "httpHeaderAuth": {
          "id": "kD67zWQcLpvywNGg",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://google-auth-server-ds--telegram-bot-ac92a.us-central1.hosted.app/api/list-events-by-time",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "firebaseUid",
              "value": "={{ $json.payload.firebaseUid }}"
            },
            {
              "name": "timeMin",
              "value": "={{ $json.payload.timeMin }}"
            },
            {
              "name": "timeMax",
              "value": "={{ $json.payload.timeMax }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        544,
        352
      ],
      "id": "c7ad82f8-a8d8-4716-8ebf-e3211b971c6f",
      "name": "Mostrar eventos",
      "credentials": {
        "httpHeaderAuth": {
          "id": "kD67zWQcLpvywNGg",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "text": "=‚úÖ Evento Creado: {{ $json.eventLink }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        752,
        -256
      ],
      "id": "b26f9205-3bf0-4db5-9ff1-986d1c68d856",
      "name": "Mensaje de creacion exitosa",
      "webhookId": "98536582-1105-4149-9a17-c5147f24d263",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        112,
        384
      ],
      "id": "0d62af44-f9fe-42b6-a481-cc5d852a6e2e",
      "name": "Enviar mensaje de error",
      "webhookId": "43d94a43-ff05-404c-892d-b908dbfedf33",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        544,
        560
      ],
      "id": "8bc19c89-6149-420b-b921-a9e82548a9d1",
      "name": "Mensaje de bienvenida",
      "webhookId": "e560c001-80d0-4c17-b8da-8e003a1bedbd",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        544,
        768
      ],
      "id": "10b3a424-433e-4d68-a6dc-9710f6a5187b",
      "name": "Mensaje de ayuda",
      "webhookId": "e560c001-80d0-4c17-b8da-8e003a1bedbd",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const DEFAULT_TIMEZONE = \"America/Mexico_City\";\n\nfunction parseSpanishDate(text) {\n    const months = {\n        'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3, 'mayo': 4, 'junio': 5,\n        'julio': 6, 'agosto': 7, 'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11\n    };\n    \n    const pad = (n) => n < 10 ? '0' + n : n;\n    const lowerText = text.toLowerCase().trim();\n    const now = new Date(); \n    \n    // C√°lculo manual de offset para forzar UTC-6 sin depender de la configuraci√≥n del servidor\n    const offsetMexico = -6 * 60; \n    const nowMexico = new Date(now.getTime() + (offsetMexico * 60 * 1000));\n\n    let year, monthIdx, day, hour, minute;\n    let yearExplicitlyProvided = false;\n\n    // Logica para extraer horas en formatos variados (2:00pm, 14:00, 9 am)\n    const extractTime = (str, defaultHour) => {\n        const timeRegex = /(\\d{1,2})(?:[:\\.](\\d{2}))?\\s*([ap]\\.?m\\.?)?/i;\n        const match = str.match(timeRegex);\n        \n        let h = defaultHour; \n        let m = 0;\n        \n        if (match) {\n            h = parseInt(match[1]);\n            m = match[2] ? parseInt(match[2]) : 0;\n            const ampm = match[3] ? match[3].replace(/\\./g, '').toLowerCase() : null;\n            \n            if (ampm === 'pm' && h < 12) h += 12;\n            if (ampm === 'am' && h === 12) h = 0;\n        }\n        return { h, m };\n    };\n\n    // A. L√≥gica para fechas relativas (Hoy/Ma√±ana)\n    if (lowerText.includes('ma√±ana') || lowerText.includes('hoy')) {\n        const baseDate = new Date(nowMexico);\n        if (lowerText.includes('ma√±ana')) baseDate.setDate(baseDate.getDate() + 1);\n\n        year = baseDate.getUTCFullYear();\n        monthIdx = baseDate.getUTCMonth();\n        day = baseDate.getUTCDate();\n\n        let defaultH = 9;\n        if (lowerText.includes('hoy') && !lowerText.match(/\\d/)) {\n            defaultH = nowMexico.getUTCHours() + 1;\n        }\n        \n        const timeObj = extractTime(lowerText, defaultH);\n        hour = timeObj.h;\n        minute = timeObj.m;\n\n    } else {\n        // B. Regex para fechas expl√≠citas (ej: \"15 de enero\", \"15 enero 2025\")\n        const dateRegex = /(\\d{1,2})(?:\\s+de\\s+|\\s+)([a-z√°√©√≠√≥√∫]+)(?:\\s+(?:del?|de)?\\s*(\\d{4}))?/i;\n        const match = lowerText.match(dateRegex);\n\n        if (!match) {\n            // Fallback a ISO est√°ndar si falla el NLP\n            const isoDate = new Date(text);\n            if (!isNaN(isoDate.getTime())) {\n                return isoDate.toISOString().split('.')[0] + \"-06:00\";\n            }\n            return null; \n        }\n\n        day = parseInt(match[1]);\n        const monthName = match[2];\n        \n        if (months[monthName] === undefined) return null;\n        monthIdx = months[monthName];\n\n        if (match[3]) {\n            year = parseInt(match[3]);\n            yearExplicitlyProvided = true;\n        } else {\n            year = nowMexico.getUTCFullYear();\n        }\n\n        const textWithoutDate = lowerText.replace(match[0], '');\n        const timeObj = extractTime(textWithoutDate, 9);\n        hour = timeObj.h;\n        minute = timeObj.m;\n    }\n\n    // Construcci√≥n manual de ISO string para garantizar zona horaria correcta\n    let isoString = `${year}-${pad(monthIdx + 1)}-${pad(day)}T${pad(hour)}:${pad(minute)}:00-06:00`;\n    let parsedDate = new Date(isoString);\n\n    // Si la fecha ya pas√≥ este a√±o, asumir el siguiente\n    if (!yearExplicitlyProvided && parsedDate < now) {\n        const isSameDay = parsedDate.getDate() === now.getDate() && parsedDate.getMonth() === now.getMonth();\n        if (!isSameDay) {\n            year += 1;\n            isoString = `${year}-${pad(monthIdx + 1)}-${pad(day)}T${pad(hour)}:${pad(minute)}:00-06:00`;\n        }\n    }\n\n    return isoString;\n}\n\nclass CommandStrategy {\n    validate(args) { return { isValid: false, message: \"Error interno\" }; }\n    buildPayload(args, uid) { return {}; }\n    \n    // Utilidad para sumar 1 hora preservando el contexto de Timezone MX\n    addOneHourSafe(isoDateString) {\n        const date = new Date(isoDateString);\n        date.setHours(date.getHours() + 1);\n        const options = { \n            timeZone: \"America/Mexico_City\", \n            year: 'numeric', month: '2-digit', day: '2-digit', \n            hour: '2-digit', minute: '2-digit', second: '2-digit', \n            hour12: false \n        };\n        const formatter = new Intl.DateTimeFormat('en-CA', options); \n        const parts = formatter.formatToParts(date);\n        const getPart = (type) => parts.find(p => p.type === type).value;\n        return `${getPart('year')}-${getPart('month')}-${getPart('day')}T${getPart('hour')}:${getPart('minute')}:${getPart('second')}-06:00`;\n    }\n}\n\nclass WelcomeStrategy extends CommandStrategy {\n    validate(args) { return { isValid: true }; }\n    buildPayload(args, uid) {\n        return {\n            message: \"üëã ¬°Hola! Soy tu asistente de calendario.\\n\\n‚ö° **Comando R√°pido:**\\n`/agendar T√≠tulo | Fecha Inicio`\\n_(Se crear√° un evento de 1 hora autom√°ticamente)_\\n\\nComandos disponibles:\\nüìÖ `/agendar` - Crear eventos\\nüîç `/modificar` - Cambiar horario\\nüóëÔ∏è `/cancelar` - Borrar eventos\\nüóìÔ∏è `/checar` - Ver agenda\\n\\nEscribe `/help` para ver todos los detalles.\",\n            action: 'bienvenida' \n        };\n    }\n}\n\nclass HelpStrategy extends CommandStrategy {\n    validate(args) { return { isValid: true }; }\n    buildPayload(args, uid) {\n        return {\n            message: \"üìò **CENTRO DE AYUDA Y COMANDOS**\\n\\n\" +\n                     \"üìÖ **1. AGENDAR EVENTOS**\\n\" +\n                     \"Tienes dos formas de crear eventos:\\n\" +\n                     \"üîπ **R√°pida (1 hora autom√°tica):**\\n\" +\n                     \"`/agendar T√≠tulo | Fecha Inicio`\\n\" +\n                     \"Ej: `/agendar Gym | hoy a las 18:00`\\n\\n\" +\n                     \"üîπ **Completa (Inicio y Fin):**\\n\" +\n                     \"`/agendar T√≠tulo | Inicio | Fin`\\n\" +\n                     \"Ej: `/agendar Reuni√≥n | ma√±ana 9am | ma√±ana 10:30am`\\n\\n\" +\n                     \"--------------------------------\\n\\n\" +\n                     \"üîç **2. MODIFICAR EVENTOS**\\n\" +\n                     \"Busca por t√≠tulo y cambia el horario:\\n\" +\n                     \"üîπ **R√°pida (Mover a nueva hora):**\\n\" +\n                     \"`/modificar T√≠tulo | Nueva Inicio`\\n\" +\n                     \"Ej: `/modificar Gym | hoy 19:00`\\n\\n\" +\n                     \"üîπ **Completa (Cambiar todo):**\\n\" +\n                     \"`/modificar T√≠tulo | Inicio | Fin`\\n\\n\" +\n                     \"--------------------------------\\n\\n\" +\n                     \"‚ú® **3. OPCIONES EXTRAS**\\n\" +\n                     \"Al Agendar o Modificar, agrega detalles al final con `|`:\\n\" +\n                     \"üìù `| Descripci√≥n: nota del evento`\\n\" +\n                     \"üìç `| Ubicaci√≥n: lugar o link`\\n\" +\n                     \"üë• `| Asistentes: correo1@gmail.com, correo2@hotmail.com`\\n\\n\" +\n                     \"üí° *Ejemplo Pro:*\\n\" +\n                     \"`/agendar Cita Dr | viernes 16:00 | Ubicaci√≥n: Clinica | Descripci√≥n: Llevar estudios`\\n\\n\" +\n                     \"--------------------------------\\n\\n\" +\n                     \"üóìÔ∏è **4. CONSULTAR AGENDA (NUEVO)**\\n\" +\n                     \"Puedes ver tu agenda por d√≠a o por rango:\\n\" +\n                     \"‚Ä¢ `/checar hoy`\\n\" +\n                     \"‚Ä¢ `/checar ma√±ana`\\n\" +\n                     \"‚Ä¢ `/checar 1 semana` (Pr√≥ximos 7 d√≠as)\\n\" +\n                     \"‚Ä¢ `/checar 15 dias`\\n\" +\n                     \"‚Ä¢ `/checar 1 mes`\\n\\n\" +\n                     \"--------------------------------\\n\\n\" +\n                     \"üóëÔ∏è **5. CANCELAR**\\n\" +\n                     \"`/cancelar T√≠tulo Exacto`\",\n            action: 'ayuda'\n        };\n    }\n}\n\nclass CreateStrategy extends CommandStrategy {\n    parseEventArgs(args) {\n        const parts = args.split('|').map(s => s.trim());\n        if (parts.length < 2) return { isValid: false, message: \"‚ùå **Faltan datos.**\\nUsa: `/agendar T√≠tulo | Fecha Inicio`\" };\n\n        const summary = parts[0];\n        const startDateStr = parts[1];\n        if (!summary) return { isValid: false, message: \"‚ùå El t√≠tulo no puede estar vac√≠o.\" };\n\n        const parsedStartDate = parseSpanishDate(startDateStr);\n        if (!parsedStartDate) return { isValid: false, message: `‚ùå No entend√≠ la fecha de inicio: \"${startDateStr}\".` };\n\n        let parsedEndDate = null;\n        let optionalParamsStartIndex = 2;\n\n        if (parts.length > 2) {\n            const possibleEndDateStr = parts[2];\n            const possibleEndDate = parseSpanishDate(possibleEndDateStr);\n            if (possibleEndDate) {\n                parsedEndDate = possibleEndDate;\n                optionalParamsStartIndex = 3;\n            } \n        }\n\n        if (!parsedEndDate) parsedEndDate = this.addOneHourSafe(parsedStartDate);\n        if (new Date(parsedStartDate) >= new Date(parsedEndDate)) return { isValid: false, message: \"‚ùå La fecha de inicio debe ser anterior a la de fin.\" };\n\n        let description, location;\n        const attendees = [];\n\n        for (let i = optionalParamsStartIndex; i < parts.length; i++) {\n            const part = parts[i];\n            const lowerPart = part.toLowerCase();\n            if (lowerPart.startsWith('descripci√≥n:')) description = part.substring('descripci√≥n:'.length).trim();\n            else if (lowerPart.startsWith('ubicaci√≥n:')) location = part.substring('ubicaci√≥n:'.length).trim();\n            else if (lowerPart.startsWith('asistentes:')) {\n                const emailsStr = part.substring('asistentes:'.length).trim();\n                emailsStr.split(',').forEach(email => {\n                    const trimmedEmail = email.trim();\n                    if (trimmedEmail) attendees.push({ email: trimmedEmail });\n                });\n            }\n        }\n\n        return { isValid: true, summary, parsedStartDate, parsedEndDate, description: description || undefined, location: location || undefined, attendees: attendees.length > 0 ? attendees : undefined };\n    }\n    validate(args) { return this.parseEventArgs(args); }\n    buildPayload(args, uid, validationResult) {\n        const data = validationResult;\n        const eventDetails = {\n            summary: data.summary,\n            description: data.description || \"Creado desde Telegram\",\n            start: { dateTime: data.parsedStartDate, timeZone: DEFAULT_TIMEZONE },\n            end: { dateTime: data.parsedEndDate, timeZone: DEFAULT_TIMEZONE }\n        };\n        if (data.location) eventDetails.location = data.location;\n        if (data.attendees) eventDetails.attendees = data.attendees;\n        return { firebaseUid: uid, eventDetails: eventDetails };\n    }\n}\n\nclass UpdateStrategy extends CommandStrategy {\n    validate(args) {\n        const parts = args.split('|').map(s => s.trim());\n        if (parts.length < 2) return { isValid: false, message: \"‚ùå **Faltan datos.**\\nUsa: `/modificar T√≠tulo | Nueva Inicio`\" };\n        \n        const searchTitle = parts[0];\n        const startDateStr = parts[1];\n        if (!searchTitle) return { isValid: false, message: \"‚ùå Falta el t√≠tulo.\" };\n\n        const parsedStartDate = parseSpanishDate(startDateStr);\n        if (!parsedStartDate) return { isValid: false, message: \"‚ùå Nueva fecha de inicio inv√°lida.\" };\n\n        let parsedEndDate = null;\n        let optionalParamsStartIndex = 2;\n\n        if (parts.length > 2) {\n            const possibleEndDateStr = parts[2];\n            const possibleEndDate = parseSpanishDate(possibleEndDateStr);\n            if (possibleEndDate) {\n                parsedEndDate = possibleEndDate;\n                optionalParamsStartIndex = 3;\n            } \n        }\n\n        if (!parsedEndDate) parsedEndDate = this.addOneHourSafe(parsedStartDate);\n        if (new Date(parsedStartDate) >= new Date(parsedEndDate)) return { isValid: false, message: \"‚ùå Inicio debe ser antes del fin.\" };\n\n        let description, location;\n        const attendees = [];\n        for (let i = optionalParamsStartIndex; i < parts.length; i++) {\n            const part = parts[i];\n            const lowerPart = part.toLowerCase();\n            if (lowerPart.startsWith('descripci√≥n:')) description = part.substring('descripci√≥n:'.length).trim();\n            else if (lowerPart.startsWith('ubicaci√≥n:')) location = part.substring('ubicaci√≥n:'.length).trim();\n            else if (lowerPart.startsWith('asistentes:')) {\n                const emailsStr = part.substring('asistentes:'.length).trim();\n                emailsStr.split(',').forEach(email => {\n                    const trimmedEmail = email.trim();\n                    if (trimmedEmail) attendees.push({ email: trimmedEmail });\n                });\n            }\n        }\n\n        return { isValid: true, parsedStartDate, parsedEndDate, searchTitle, description, location, attendees: attendees.length > 0 ? attendees : undefined };\n    }\n    buildPayload(args, uid, validationResult) {\n        const data = validationResult;\n        const eventDetails = {\n            start: { dateTime: data.parsedStartDate, timeZone: DEFAULT_TIMEZONE },\n            end: { dateTime: data.parsedEndDate, timeZone: DEFAULT_TIMEZONE }\n        };\n        if (data.description) eventDetails.description = data.description;\n        if (data.location) eventDetails.location = data.location;\n        if (data.attendees) eventDetails.attendees = data.attendees;\n        return { firebaseUid: uid, searchTitle: data.searchTitle, eventDetails: eventDetails };\n    }\n}\n\nclass DeleteStrategy extends CommandStrategy {\n    validate(args) {\n        if (!args.trim()) return { isValid: false, message: \"‚ùå **Falta el t√≠tulo.**\\nUsa: `/cancelar T√≠tulo del Evento`\" };\n        return { isValid: true };\n    }\n    buildPayload(args, uid) {\n        return { firebaseUid: uid, searchTitle: args.trim() };\n    }\n}\n\nclass CheckStrategy extends CommandStrategy {\n    \n    // Formatea Date a ISO string respetando hardcoded timezone (-06:00)\n    getMexicoISO(dateObj) {\n        const options = { \n            timeZone: \"America/Mexico_City\", \n            year: 'numeric', month: '2-digit', day: '2-digit', \n            hour: '2-digit', minute: '2-digit', second: '2-digit', \n            hour12: false \n        };\n        const formatter = new Intl.DateTimeFormat('en-CA', options);\n        const parts = formatter.formatToParts(dateObj);\n        const getPart = (type) => parts.find(p => p.type === type).value;\n        \n        return `${getPart('year')}-${getPart('month')}-${getPart('day')}T${getPart('hour')}:${getPart('minute')}:${getPart('second')}-06:00`;\n    }\n\n    validate(args) {\n        const text = args.trim().toLowerCase();\n        if (!text) return { isValid: false, message: \"‚ùå **Falta el rango.**\\nEj: `/checar hoy`, `/checar 1 semana`\" };\n        \n        const now = new Date();\n        const nowISO = this.getMexicoISO(now); \n\n        // 1. Prioridad a \"hoy\" (Desde ahora mismo hasta fin del d√≠a)\n        if (text === 'hoy') {\n            const todayDatePart = nowISO.split('T')[0]; \n            return { \n                isValid: true, \n                timeMin: nowISO, \n                timeMax: `${todayDatePart}T23:59:59-06:00`\n            };\n        }\n\n        // 2. Parseo de rangos naturales (1 semana, 2 dias)\n        const rangeRegex = /^(\\d+)\\s*(dias?|semanas?|mes(?:es)?)$/i;\n        const match = text.match(rangeRegex);\n\n        if (match) {\n            const quantity = parseInt(match[1]);\n            const unit = match[2];\n            \n            const timeMin = nowISO;\n            const endDate = new Date(now);\n            \n            if (unit.startsWith('dia')) {\n                endDate.setDate(endDate.getDate() + quantity);\n            } else if (unit.startsWith('semana')) {\n                endDate.setDate(endDate.getDate() + (quantity * 7));\n            } else if (unit.startsWith('mes')) {\n                endDate.setMonth(endDate.getMonth() + quantity);\n            }\n            \n            const endISO = this.getMexicoISO(endDate);\n            const endDatePart = endISO.split('T')[0];\n            const timeMax = `${endDatePart}T23:59:59-06:00`; \n\n            return { isValid: true, timeMin, timeMax };\n        }\n\n        // 3. Fechas espec√≠ficas futuras\n        const parsedDateStr = parseSpanishDate(text);\n        if (parsedDateStr) {\n            const baseDateString = parsedDateStr.substring(0, 10); \n            \n            return { \n                isValid: true, \n                timeMin: `${baseDateString}T00:00:00-06:00`,\n                timeMax: `${baseDateString}T23:59:59-06:00`\n            };\n        }\n\n        return { isValid: false, message: \"‚ùå No entend√≠ el rango.\\nIntenta: `/checar 1 semana` o `/checar hoy`\" };\n    }\n\n    buildPayload(args, uid, validationResult) {\n        return {\n            firebaseUid: uid,\n            timeMin: validationResult.timeMin,\n            timeMax: validationResult.timeMax\n        };\n    }\n}\n\nclass CommandContext {\n    constructor(msg) {\n        this.rawText = (msg.text || \"\").trim();\n        this.chatId = msg.chat.id;\n        this.firebaseUid = String(msg.chat.id); \n    }\n    parse() {\n        const lower = this.rawText.toLowerCase();\n        if (lower === '/help' || lower.includes('ayuda')) return { action: 'help', args: '' };\n        if (['hola', 'inicio', 'start'].some(w => lower.includes(w)) || lower === '/start') return { action: 'welcome', args: '' };\n        if (this.rawText.startsWith('/')) {\n            const clean = this.rawText.substring(1);\n            const firstSpace = clean.indexOf(' ');\n            const action = firstSpace === -1 ? clean : clean.substring(0, firstSpace);\n            const args = firstSpace === -1 ? \"\" : clean.substring(firstSpace + 1);\n            return { action: action.toLowerCase(), args };\n        }\n        return { action: 'unknown', args: '' };\n    }\n}\n\nfunction getStrategy(action) {\n    switch (action) {\n        case 'welcome': return new WelcomeStrategy();\n        case 'help': return new HelpStrategy();\n        case 'agendar': return new CreateStrategy();\n        case 'modificar': return new UpdateStrategy();\n        case 'cancelar': return new DeleteStrategy();\n        case 'checar': case 'listar': return new CheckStrategy(); \n        default: return null;\n    }\n}\n\nlet msg;\ntry { msg = $('Mensaje del usuario').item.json.message; } \ncatch (e) { msg = $input.item.json.message; }\n\nconst context = new CommandContext(msg);\nconst { action, args } = context.parse();\nconst strategy = getStrategy(action);\nlet result = { action, isValid: false, message: \"\", payload: {} };\n\nif (strategy) {\n    const validation = strategy.validate(args);\n    if (validation.isValid) {\n        result.isValid = true;\n        if (action === 'welcome' || action === 'help') {\n            const strategyResult = strategy.buildPayload(args, context.firebaseUid);\n            result.message = strategyResult.message;\n            result.action = strategyResult.action; \n            result.payload = {};\n        } else {\n            result.message = \"Procesando...\";\n            result.payload = strategy.buildPayload(args, context.firebaseUid, validation);\n        }\n    } else {\n        result.message = validation.message;\n        if (!result.message.includes('/help')) result.message += \"\\n\\nEscribe `/help` para ver los formatos.\";\n    }\n} else {\n    result.message = \"‚ö†Ô∏è No entend√≠ tu comando. Escribe `/help` para ayuda.\";\n}\nreturn { json: result };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        96
      ],
      "id": "547d65a3-1cd8-4e23-a869-a0cff893b1d0",
      "name": "Main code"
    },
    {
      "parameters": {
        "chatId": "={{ $('Mensaje del usuario').item.json.message.chat.id }}",
        "text": "Por favor inicia sesi√≥n en tu cuenta de Google y acepta los permisos.",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Iniciar sesi√≥n",
                    "additionalFields": {
                      "url": "={{ $json.login_url }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -304,
        336
      ],
      "id": "2821f000-836b-4ed8-8470-b1fd41086a9c",
      "name": "Send a text message1",
      "webhookId": "d62f4c99-4e71-4316-9eba-9f27368b5c2f",
      "credentials": {
        "telegramApi": {
          "id": "XUhf7DpMbFlYJJFz",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const events = $input.item.json.events || [];\n\nconst options = { \n  timeZone: \"America/Mexico_City\", \n  weekday: 'long', \n  day: 'numeric', \n  month: 'short', \n  hour: '2-digit', \n  minute: '2-digit',\n  hour12: false\n};\n\nconst capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);\n\nif (events.length === 0) {\n  return {\n    json: {\n      message: \"üì≠ **Agenda vac√≠a**\\nNo encontr√© eventos en este rango de fechas.\"\n    }\n  };\n}\n\nlet message = `üóìÔ∏è **Tus Eventos Encontrados (${events.length}):**\\n\\n`;\n\nevents.forEach(event => {\n  const summary = event.summary || \"Sin t√≠tulo\";\n  const startRaw = event.start.dateTime || event.start.date;\n  const startDate = new Date(startRaw);\n  \n  const formatter = new Intl.DateTimeFormat('es-MX', options);\n  const dateString = formatter.format(startDate);\n  \n  const finalDate = capitalize(dateString).replace(',', '').replace('.', '');\n\n  message += `üïí ${finalDate} hrs\\nüìå **${summary}**\\n\\n`;\n});\n\nmessage += \"üí° _Usa /modificar o /cancelar seguido del t√≠tulo para editar._\";\n\nreturn {\n  json: {\n    message: message\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        352
      ],
      "id": "1bee6236-ae9d-4891-90df-1798cfed4196",
      "name": "Parsear fechas para get"
    }
  ],
  "pinData": {},
  "connections": {
    "Check Validity": {
      "main": [
        [
          {
            "node": "Action Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar mensaje de error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Action Router": {
      "main": [
        [
          {
            "node": "Crear evento en calendario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Editar evento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Eliminar evento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mostrar eventos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje de bienvenida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje de ayuda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje del usuario": {
      "main": [
        [
          {
            "node": "Verificar en BD status de autenticacion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar en BD status de autenticacion": {
      "main": [
        [
          {
            "node": "autenticado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar usuario": {
      "main": [
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear evento en calendario": {
      "main": [
        [
          {
            "node": "Mensaje de creacion exitosa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "autenticado?": {
      "main": [
        [
          {
            "node": "Main code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Autenticar usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Editar evento": {
      "main": [
        [
          {
            "node": "Send a text message5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Eliminar evento": {
      "main": [
        [
          {
            "node": "Send a text message6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mostrar eventos": {
      "main": [
        [
          {
            "node": "Parsear fechas para get",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Main code": {
      "main": [
        [
          {
            "node": "Check Validity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear fechas para get": {
      "main": [
        [
          {
            "node": "Send a text message3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c7e3c380-0d17-40b1-a17c-51f43e6aae4f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f21631604bf1df349c9da1efdc0d69d42809c5e513ee12d92b1db9a118e0c25d"
  },
  "id": "NUDUwg79M5D6GC0n",
  "tags": []
}